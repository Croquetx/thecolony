/*--------------------------------- * The Animator * Copyright 1988 by David A. Smith * All Rights Reserved * 111 Gold Meadow Dr. * Cary, NC 27513 *---------------------------------*/#define EXT extern #include "adefs.h"WindowRecord bgRecord;Rect bgTopEdit,bgTopShow;Rect bgBottomEdit,bgBottomShow;/*--------------------------------------------------------------------- * InitBackGround(bg) * int bg[16]; *--------------------------------------------------------------------- */InitBackGround(setTopBG,setBottomBG)char setTopBG[8],setBottomBG[8];{Rect r;int i;SetRect(&r, 4, 43,168, 198);SetPort((bgWindow = NewWindow( &bgRecord , &r, "\pBackGround",	1, 0, -1L, 0, 0L)));for(i=0;i<8;i++)	{	newTopBG[i]=topBG[i]=setTopBG[i];	newBottomBG[i]=bottomBG[i]=setBottomBG[i];	}divideBG=170;}/*--------------------------------------------------------------------- *--------------------------------------------------------------------- */DrawBGWindow(){GrafPtr	savePort;int i,j;Rect r;/*do top pattern*/GetPort( &savePort );SetPort(bgWindow);bgTopEdit.top=8;bgTopEdit.bottom=11+8*8;bgTopEdit.left=8;bgTopEdit.right=11+8*8;FillRect(&bgTopEdit,white);FrameRect(&bgTopEdit);for(i=0;i<8;i++)	for(j=0;j<8;j++)		if(topBG[i]&(1<<(7-j)))			{			r.top=10+i*8;			r.bottom=r.top+7;			r.left=10+j*8;			r.right=r.left+7;			FillRect(&r,black);			}bgTopShow.top=16+8*8;bgTopShow.bottom=3+bgTopShow.top+8*8;bgTopShow.left=8;bgTopShow.right=3+bgTopShow.left+8*8;FillRect(&bgTopShow,newTopBG);FrameRect(&bgTopShow);/*do bottom pattern*/bgBottomEdit.top=8;bgBottomEdit.bottom=11+8*8;bgBottomEdit.left=88;bgBottomEdit.right=91+8*8;FillRect(&bgBottomEdit,white);FrameRect(&bgBottomEdit);for(i=0;i<8;i++)	for(j=0;j<8;j++)		if(bottomBG[i]&(1<<(7-j)))			{			r.top=10+i*8;			r.bottom=r.top+7;			r.left=90+j*8;			r.right=r.left+7;			FillRect(&r,black);			}bgBottomShow.top=16+8*8;bgBottomShow.bottom=3+bgBottomShow.top+8*8;bgBottomShow.left=88;bgBottomShow.right=3+bgBottomShow.left+8*8;FillRect(&bgBottomShow,newBottomBG);FrameRect(&bgBottomShow);SetPort(savePort);}/*----------------------------------------------------------------------*/DrawBackGround(meta)GrafPort* meta;{int i;GrafPtr	savePort;Rect r;GetPort( &savePort );SetPort(meta);r.top=DClip.top;r.left=DClip.left;r.right=DClip.right;r.bottom=divideBG;FillRect(&r,topBG);r.top=r.bottom;r.bottom=DClip.bottom;FillRect(&r,bottomBG);MoveTo(DClip.left,divideBG); LineTo(DClip.right,divideBG);if(background.active)	{	ClipRect(&DClip);	CopyBits(background.mask,		&meta->portBits,		&background.clip,&background.locate,		srcBic,NIL);	CopyBits(background.fg,		&meta->portBits,		&background.clip,&background.locate,		srcOr,NIL);	ClipRect(&size);	}SetPort(savePort);}/*----------------------------------------------------------------------*/BGUpdate(){GrafPtr	savePort;GetPort( &savePort );BeginUpdate(bgWindow);DrawBGWindow();EndUpdate(bgWindow);SetPort( savePort );}/*----------------------------------------------------------------------*/DoBackGround(){Point p;Rect r;int x,y,color,ox,oy;int i;GrafPtr	savePort;GetPort( &savePort );SetPort(bgWindow);GetMouse(&p);if(PtInRect(p,&bgTopShow))	{	for(i=0;i<8;i++)		topBG[i]=newTopBG[i];	DrawBackGround(&meta0);	DrawPlane();/*draw in the foreground*/	DejaDCopy();	DrawBackGround(&meta1);	DrawAnim();	AnimDCopy();	changed=TRUE;	}else if(PtInRect(p,&bgBottomShow))	{	for(i=0;i<8;i++)		bottomBG[i]=newBottomBG[i];	DrawBackGround(&meta0);	DrawPlane();/*draw in the foreground*/	DejaDCopy();	DrawBackGround(&meta1);	DrawAnim();	AnimDCopy();	changed=TRUE;	}else if(PtInRect(p,&bgTopEdit))	{	x=(p.h-10)/8;	y=(p.v-10)/8;	if(x>=0 && x<8 && y>=0 && y<8)		{		color=!(newTopBG[y]&(1<<(7-x)));		r.top=10+y*8;		r.bottom=r.top+7;		r.left=10+x*8;		r.right=r.left+7;		if(color)			{			FillRect(&r,black);			newTopBG[y]|=(1<<(7-x));			}		else			{			FillRect(&r,white);			newTopBG[y]&=~(1<<(7-x));			}		ox=x; oy=y;		while(Button())			{			GetMouse(&p);			x=(p.h-10)/8;			y=(p.v-10)/8;			if(x>=0 && x<8 && y>=0 && y<8)				{				if(ox!=x || oy!=y)					{					r.top=10+y*8;					r.bottom=r.top+7;					r.left=10+x*8;					r.right=r.left+7;					if(color)						{						FillRect(&r,black);						newTopBG[y]|=(1<<(7-x));						}					else						{						FillRect(&r,white);						newTopBG[y]&=~(1<<(7-x));						}					ox=x; oy=y;					}				}			}		}	FillRect(&bgTopShow,newTopBG);	FrameRect(&bgTopShow);	changed=TRUE;	}else if(PtInRect(p,&bgBottomEdit))	{	x=(p.h-90)/8;	y=(p.v-10)/8;	if(x>=0 && x<8 && y>=0 && y<8)		{		color=!(newBottomBG[y]&(1<<(7-x)));		r.top=10+y*8;		r.bottom=r.top+7;		r.left=90+x*8;		r.right=r.left+7;		if(color)			{			FillRect(&r,black);			newBottomBG[y]|=(1<<(7-x));			}		else			{			FillRect(&r,white);			newBottomBG[y]&=~(1<<(7-x));			}		ox=x; oy=y;		while(Button())			{			GetMouse(&p);			x=(p.h-90)/8;			y=(p.v-10)/8;			if(x>=0 && x<8 && y>=0 && y<8)				{				if(ox!=x || oy!=y)					{					r.top=10+y*8;					r.bottom=r.top+7;					r.left=90+x*8;					r.right=r.left+7;					if(color)						{						FillRect(&r,black);						newBottomBG[y]|=(1<<(7-x));						}					else						{						FillRect(&r,white);						newBottomBG[y]&=~(1<<(7-x));						}					ox=x; oy=y;					}				}			}		}	FillRect(&bgBottomShow,newBottomBG);	FrameRect(&bgBottomShow);	changed=TRUE;	}SetPort( savePort );}/*----------------------------------------------------------------------*/bgPaste(){long length;long offset;int xSize,ySize;GrafPtr temp;PicHandle pict;GrafPtr	savePort;int i;extern BitMap* MakeBitMap();GetPort( &savePort );pict=(PicHandle)NewHandle(0);length=GetScrap(pict,'PICT',&offset);if(length>0)	{	/*make room*/	if(background.active)/*kill old background*/		{		DisposHandle(background.pict);		KillBitMap(background.fg);		KillBitMap(background.mask);		}	SizeRect(&xSize,&ySize,&(**pict).picFrame);	background.pict=pict;	background.clip.top=0; 	background.clip.bottom=ySize;	background.clip.left=0; 	background.clip.right=xSize;	background.locate.top=background.clip.top;	background.locate.bottom=background.clip.bottom;	background.locate.left=background.clip.left;	background.locate.right=background.clip.right;	background.fg=MakeBitMap(&background.clip);	background.mask=MakeBitMap(&background.clip);	temp=(GrafPtr)NewPtr((long)sizeof(GrafPort));	OpenPort(temp);	SetPortBits(background.fg);	SetOrigin(0,0);	PenMode(patCopy);	DrawPicture(pict,&background.clip);	ClosePort(temp);	DisposPtr(temp);	CalcMask(background.fg->baseAddr,		background.mask->baseAddr,		background.fg->rowBytes,		background.mask->rowBytes,ySize,		background.fg->rowBytes/2);	background.active=TRUE;		DrawBackGround(&meta0);	DrawPlane();/*draw in the foreground*/	DejaDCopy();	DrawBackGround(&meta1);	DrawAnim();	AnimDCopy();	changed=TRUE;	}SetPort(savePort);}/*----------------------------------------------------------------------*/bgCut(){int i;if(!background.active)return;ZeroScrap();PutScrap(GetHandleSize(background.pict),	'PICT',*background.pict);DisposHandle(background.pict);KillBitMap(background.fg);KillBitMap(background.mask);background.active=0;DoBackGround();changed=TRUE;}/*----------------------------------------------------------------------*/bgCopy(){struct sprite *previous,*next,*this;if(!background.active)	{	SysBeep(10);	return;	}ZeroScrap();PutScrap(GetHandleSize(background.pict),	'PICT',*background.pict);}/*--------------------------------------------------------------------- *--------------------------------------------------------------------- */MoveBG(p)Point *p;{Rect r,dummy;Point new,old;int i,overlap;int xloc,yloc;if(p->v>=divideBG-1 && p->v<=divideBG+1)	{	while(Button())		{		GetMouse(&new);		divideBG=new.v;		DrawBackGround(&meta0);		DrawPlane();/*draw in the foreground*/		DejaDCopy();		}	}else 	{	old.v=p->v;	old.h=p->h;	while(Button())		{		GetMouse(&new);		overlap=FALSE;		if(new.v>0&&new.v<(HEIGHT-BTOP)&&new.h>0&&new.h<WIDTH)		if(new.v!=old.v || new.h!=old.h)			{			background.locate.left+=new.h-old.h;			background.locate.right+=new.h-old.h;			background.locate.top+=new.v-old.v;			background.locate.bottom+=new.v-old.v;			old.h=new.h;			old.v=new.v; 			DrawBackGround(&meta0);			DrawPlane();/*draw in the foreground*/			DejaDCopy();			}		}	}DrawBackGround(&meta1);DrawAnim();AnimDCopy();changed=TRUE;}