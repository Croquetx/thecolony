/*-------------------------------------------------------------------- * mapfile.c * * Map file system. * Used to load and save the maps that are edited. * Copyright 1987 by David A. Smith... *-------------------------------------------------------------------- */#define MAPEXT extern#include "mapdefs.h"#include <FileMgr.h>#include <StdFilePkg.h>#include <SegmentLdr.h>int		filnum;int		volnum;char	volname[255];StringPtr	filname=(StringPtr)"\pUntitled";Point putpnt,getpnt;long type='MAP_';long create='TERI';IOParam pblk;FileParam fblk;SFReply reply;AppFile theFile;/*----------------------------------------------------------------------*/NameUntitled(){SetWTitle(theWindow,"\pUntitled");pblk.ioNamePtr=filname;}/*----------------------------------------------------------------------*/int savemap(q,ch)int q,ch;{int i=0;long fsize=4096L;Point loc;OsErr err;if(q)	{	SetPt(&loc,100,80);	SFPutFile(loc  ,(StringPtr)"\pSave File as...",(StringPtr)pblk.ioNamePtr,NIL,&reply);	if(reply.good==FALSE)return(ch);	}else if(!ch)return(ch);pblk.ioNamePtr=reply.fName;pblk.ioVRefNum=reply.vRefNum;pblk.ioVersNum=reply.version;pblk.ioPermssn=fsWrPerm;pblk.ioMisc=(Ptr)NIL;err=PBCreate(&pblk,FALSE);if(err&&err!=dupFNErr)	{	SysBeep(10);	return(ch);	}err=PBOpen(&pblk,FALSE);if(err)	{	SysBeep(10);	return(ch);	}err=PBSetEOF(&pblk,FALSE);if(err)	{	SysBeep(10);	return(ch);	}my_write((Ptr)map_head,20L);my_write((Ptr)(&blength),2L);my_write((Ptr)buffer,(long)blength);err=PBClose(&pblk,FALSE);if(err)SysBeep(10);SetWTitle(theWindow,pblk.ioNamePtr);fblk.qLink=pblk.qLink;fblk.qType=pblk.qType;fblk.ioTrap=pblk.ioTrap;fblk.ioCmdAddr=pblk.ioCmdAddr;fblk.ioCompletion=pblk.ioCompletion;fblk.ioResult=pblk.ioResult;fblk.ioNamePtr=pblk.ioNamePtr;fblk.ioVRefNum=pblk.ioVRefNum;err=PBGetFInfo(&fblk,FALSE);fblk.ioFlFndrInfo.fdType=type;fblk.ioFlFndrInfo.fdCreator=create;err=PBSetFInfo(&fblk,FALSE);return(FALSE);/*indicates that data has been saved correctly*/}/*----------------------------------------------------------------------*/char name[64];int openmap(ch,load)int ch,load;{OsErr err;SFTypeList typelist;int numtypes=1;Point loc;int i=0;pblk.ioNamePtr=(StringPtr)name;if(!load)	{	SetPt(&loc,100,80);		typelist[0]=type;	SFGetFile(loc,(StringPtr)"\pLoad Map",NIL,numtypes,typelist,NIL,&reply);	if(reply.good==FALSE)return;	for(i=0;i<64;i++)pblk.ioNamePtr[i]=reply.fName[i];	pblk.ioVRefNum=reply.vRefNum;	pblk.ioVersNum=reply.version;	pblk.ioPermssn=fsRdPerm;	pblk.ioMisc=(Ptr)NIL;	}else{	GetAppFiles(1,&theFile);	pblk.ioNamePtr=theFile.fName;	pblk.ioVRefNum=theFile.vRefNum;	pblk.ioVersNum=theFile.versNum;	pblk.ioPermssn=fsRdPerm;	pblk.ioMisc=(Ptr)NIL;	}for(i=0;i<64;i++)reply.fName[i]=pblk.ioNamePtr[i];reply.vRefNum=pblk.ioVRefNum;reply.version=pblk.ioVersNum;err=PBOpen(&pblk,FALSE);if(err)	{	SysBeep(10);	return(ch);	}my_read((Ptr)map_head,(long)20);my_read((Ptr)(&blength),2L);my_read((Ptr)buffer,(long)blength);err=PBClose(&pblk,FALSE);if(err)SysBeep(10);SetWTitle(theWindow,pblk.ioNamePtr);redrawmap();return(FALSE);}/*----------------------------------------------------------------------*/my_write(buffer,length)Ptr buffer;long length;{OsErr err;pblk.ioBuffer=buffer;pblk.ioReqCount=length;pblk.ioPosMode=fsAtMark;pblk.ioPosOffset=NIL;err=PBWrite(&pblk,FALSE);if(err)	{	SysBeep(10);	}if(pblk.ioActCount!=pblk.ioReqCount)	{	SysBeep(10);	}}/*----------------------------------------------------------------------*/my_read(buffer,length)Ptr buffer;long length;{OsErr err;pblk.ioBuffer=buffer;pblk.ioReqCount=length;pblk.ioPosMode=fsAtMark;pblk.ioPosOffset=NIL;err=PBRead(&pblk,FALSE);if(err)	{	SysBeep(10);	}if(pblk.ioActCount!=pblk.ioReqCount)	{	SysBeep(10);	}}/*----------------------------------------------------------------------*/