/*--------------------------------- * The Animator * Copyright 1988 by David A. Smith * All Rights Reserved * 111 Gold Meadow Dr. * Cary, NC 27513 *---------------------------------*//*-------------------------------------------------------------------- * file.c * * Animation file system. * Used to load and save animations that are edited. * Copyright 1988 by David A. Smith... *-------------------------------------------------------------------- */#define EXT extern#include "adefs.h"#include <FileMgr.h>#include <StdFilePkg.h>#include <SegmentLdr.h>int		filnum;int		volnum;char	volname[255];StringPtr	untitled=(StringPtr)"\pUntitled";Point putpnt,getpnt;long type='ANIM';long create='TWOD';IOParam pblk;FileParam fblk;SFReply reply;AppFile theFile;/*----------------------------------------------------------------------*/loadfiles(count)int count;{if(count != 0)openanim(0,1);else{	NameUntitled();	/*DrawMeta();*/	}}/*----------------------------------------------------------------------*/NameUntitled(){int i;SetWTitle(theWindow,untitled);	pblk.ioNamePtr=untitled;}/*----------------------------------------------------------------------*/int saveanim(q,ch,pictsave)int q,ch,pictsave;{int i=0;long fsize=4096L;Point loc;OsErr err;if(q)	{	SetPt(&loc,100,80);	SFPutFile(loc  ,(StringPtr)"\pSave File as...",(StringPtr)pblk.ioNamePtr,NIL,&reply);	if(reply.good==FALSE)return(ch);	}else if(!ch)return(ch);pblk.ioNamePtr=reply.fName;pblk.ioVRefNum=reply.vRefNum;SetVol("\p",reply.vRefNum);pblk.ioVersNum=reply.version;pblk.ioPermssn=fsWrPerm;pblk.ioMisc=(Ptr)NIL;err=PBCreate(&pblk,FALSE);if(err&&err!=dupFNErr)	{	SysBeep(10);	return(ch);	}else if(err==dupFNErr)	{	PBDelete(&pblk,FALSE);	err=PBCreate(&pblk,FALSE);	}err=PBOpen(&pblk,FALSE);if(err)	{	SysBeep(10);	return(ch);	}err=PBSetEOF(&pblk,FALSE);if(err)	{	SysBeep(10);	return(ch);	}writeanim();err=PBClose(&pblk,FALSE);if(err)SysBeep(10);SetWTitle(theWindow,pblk.ioNamePtr);fblk.qLink=pblk.qLink;fblk.qType=pblk.qType;fblk.ioTrap=pblk.ioTrap;fblk.ioCmdAddr=pblk.ioCmdAddr;fblk.ioCompletion=pblk.ioCompletion;fblk.ioResult=pblk.ioResult;fblk.ioNamePtr=pblk.ioNamePtr;fblk.ioVRefNum=pblk.ioVRefNum;err=PBGetFInfo(&fblk,FALSE);fblk.ioFlFndrInfo.fdType=type;fblk.ioFlFndrInfo.fdCreator=create;err=PBSetFInfo(&fblk,FALSE);if(pictsave)writepicts(pblk.ioNamePtr);return(FALSE);/*indicates that data has been saved correctly*/}/*----------------------------------------------------------------------*/char name[64];int openanim(ch,load)int ch,load;{OsErr err;SFTypeList typelist;int numtypes=1;Point loc;int i=0;pblk.ioNamePtr=(StringPtr)name;if(!load)	{	SetPt(&loc,100,80);		typelist[0]=type;	SFGetFile(loc,(StringPtr)"\pLoad Animation",NIL,numtypes,typelist,NIL,&reply);	if(reply.good==FALSE)return;	newanim();	pblk.ioNamePtr=reply.fName;	pblk.ioVRefNum=reply.vRefNum;	SetVol("\p",reply.vRefNum);	pblk.ioVersNum=reply.version;	pblk.ioPermssn=fsRdPerm;	pblk.ioMisc=(Ptr)NIL;	}else{	GetAppFiles(1,&theFile);	pblk.ioNamePtr=theFile.fName;	pblk.ioVRefNum=theFile.vRefNum;	SetVol("\p",reply.vRefNum);	pblk.ioVersNum=theFile.versNum;	pblk.ioPermssn=fsRdPerm;	pblk.ioMisc=(Ptr)NIL;	}for(i=0;i<pblk.ioNamePtr[0]+1;i++)reply.fName[i]=pblk.ioNamePtr[i];reply.vRefNum=pblk.ioVRefNum;reply.version=pblk.ioVersNum;err=PBOpen(&pblk,FALSE);if(err)	{	SysBeep(10);	return(ch);	}readanim();err=PBClose(&pblk,FALSE);if(err)SysBeep(10);SetWTitle(theWindow,pblk.ioNamePtr);readpicts(pblk.ioNamePtr);DrawAll();return(FALSE);}/*----------------------------------------------------------------------*/my_write(buffer,length)Ptr buffer;long length;{OsErr err;pblk.ioBuffer=buffer;pblk.ioReqCount=length;pblk.ioPosMode=fsAtMark;pblk.ioPosOffset=NIL;err=PBWrite(&pblk,FALSE);if(err)	{	SysBeep(10);	}if(pblk.ioActCount!=pblk.ioReqCount)	{	SysBeep(10);	}}/*----------------------------------------------------------------------*/my_read(buffer,length)Ptr buffer;long length;{OsErr err;pblk.ioBuffer=buffer;pblk.ioReqCount=length;pblk.ioPosMode=fsAtMark;pblk.ioPosOffset=NIL;err=PBRead(&pblk,FALSE);if(err)	{	SysBeep(10);	}if(pblk.ioActCount!=pblk.ioReqCount)	{	SysBeep(10);	}}